openapi: 3.1.0
info:
  title: Waste Compactor API
  version: 1.1.0
  description: |
    Open and vendor-neutral HTTPS/JSON API between a self-service waste compactor and 
    a backend system.

    The direction of the API is compactor→backend, where compactor acts as a client 
    and backend acts as a server.
    
    Security model is based on mutual TLS (mTLS) where both sides prove their 
    identity by using X.509 certificates.

    If POST methods fail or give a timeout, the compactor MUST persist the message 
    locally and retry after a backoff period, until the message has been 
    successfully delivered. If storage space runs out, then the oldest message is overwritten.

    This API is inspired by [Zalando RESTful API and Event Guidelines](https://opensource.zalando.com/restful-api-guidelines/).
  contact:
    name: NN
  x-api-id: "urn:example:waste-compactor-api"
  x-audience: "external-partner"
servers:
  - url: https://api.example.com
    description: Production
  - url: https://sandbox.api.example.com
    description: Sandbox

tags:
  - name: health
  - name: info
  - name: status
  - name: events
  - name: alarms
  - name: entitlements
  - name: commands

security:
  - mutualTLS: []

paths:
  /health:
    get:
      tags: [health]
      summary: API health check.
      operationId: get_health
      description: >
        Checks that the API in the backend is responding.
        Infra monitoring service MAY call this method in order to check that service is alive.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Health'
        '503':
          description: Service is unavailable or degraded
          content: 
            application/json: 
              schema:
                $ref: '#/components/schemas/Health'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/info:
    post:
      tags: [info]
      summary: Send compactor information to backend.
      operationId: post_info
      description: >
        Send compactor information e.g. identification, model and version to backend.
        Compactor MUST send this message after SW restart or at least once in 24h. 
      parameters:
        - $ref: '#/components/parameters/CompactorId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Info'
      responses:
        '204':
          description: Compactor information has been updated in the backend; no response body.
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/events:
    post:
      tags: [events]
      summary: Send compactor event to backend.
      operationId: post_event
      description: Send event to backend when compactor state changes. 
      parameters:
        - $ref: '#/components/parameters/CompactorId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Event'
      responses:
        '204':
          description: Event accepted and processed successfully; no response body.
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/status:
    post:
      tags: [status]
      summary: Send compactor status to backend.
      operationId: post_status
      description: >
        Send compactor status to backend.
        Compactor MUST call this method repeatedly in 15 minute intervals.
        Backend MUST set connection status DISCONNECTED if no new request has been received for 16 minutes,
        otherwise connection status is CONNECTED.  
      parameters:
        - $ref: '#/components/parameters/CompactorId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Status'
      responses:
        '204':
          description: Status accepted and processed successfully; no response body.
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/alarm-events:
    post:
      tags: [alarms]
      summary: Send compactor alarm event (activated or cleared) to backend.
      operationId: post_alarms
      description: Send compactor alarm event (activated or cleared) to backend.
      parameters:
        - $ref: '#/components/parameters/CompactorId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Alarm'
      responses:
        '204':
          description: Alarm event accepted and processed successfully; no response body.
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/entitlement-checks:
    post:
      tags: [entitlements]
      summary: Check customer entitlements.
      operationId: check_entitlements
      description: Check entitlements for the given credential. 
      parameters:
        - $ref: '#/components/parameters/CompactorId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Credential'
      responses:
        '200':
          description: Entitlement was evaluated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntitlementCheckResponse'        
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/commands:
    get:
      tags: [commands]
      summary: Get the next remote command for the compactor to execute.
      operationId: get_next_command
      description: >
        Long-poll for a single remote command. 
        The backend returns the next available command immediately,
        or waits up to wait_seconds for one to arrive. If none arrive in time, returns 204 No Content.
        After boot or SW restart, the compactor MUST create a random initial delay (0-60 s) before
        starting the polling cycle. The compactor MUST NOT open a new GET /commands while a previous one is pending.
        The backend MAY reject overlapping GET /commands with 409 Conflict.
        The compactor MUST call this method again after the previous call returns,
        but NOT more often than once per 1 minute. 
        The compactor MUST enable TCP-keepalive that is long enough for keeping 
        the socket open during long-polls.     
      parameters:
        - $ref: '#/components/parameters/CompactorId'
        - name: wait_seconds
          in: query
          description: >
            Maximum time to wait for a command before returning 204. 
          schema: 
            type: integer
            minimum: 0
            maximum: 300
            default: 60
      responses:
        '200':
          description: A single command to execute.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Command'
        '204':
          description: No command available within wait_seconds.
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

  /compactors/{compactor_id}/commands/{command_id}/report:
    post:
      tags: [commands]
      summary: Report command execution success or failure.
      operationId: report_command_status
      description: Report command execution success or failure. 
      parameters:
        - $ref: '#/components/parameters/CompactorId'
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandReport'
      responses:
        '204': 
          description: Report accepted
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
          description: Command id was not found
        '409':
          $ref: '#/components/responses/Conflict'
          description: Command was already reported
        '422': 
          $ref: '#/components/responses/UnprocessableContent'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  securitySchemes:
    mutualTLS:
      type: mutualTLS
      description: Client and server authentication (X.509) via mutual TLS.

  parameters:
    CompactorId:
      name: compactor_id
      in: path
      required: true
      description: Unique compactor identifier
      schema:
        type: string
        examples: [WC-12345]
    CommandId:
      name: command_id
      in: path
      required: true
      description: Unique command identifier
      schema:
        type: string
        examples: [CMD-12345]

  responses:
    BadRequest:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    Unauthorized:
      description: mTLS authentication failed (or missing)
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    Forbidden:
      description: Authenticated but not authorized to perform the operation
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    Conflict:
      description: Conflict with current resource state
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    ServerError:
      description: Server error
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    UnprocessableContent:
      description: Semantic validation failed
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
  schemas:
    Timestamp:
      type: string
      description: RFC 3339 timestamp with timezone (Z or ±hh:mm).
      format: date-time
      # Varmistaa, että aikavyöhyke on mukana
      pattern: '^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:\d{2})$'
      examples: ["2025-08-27T11:05:00Z", "2025-08-27T14:05:00+03:00"]

    Health:
      type: object
      description: API health indicator
      properties:
        status:
          type: string
          enum: [OK, DEGRADED, ERROR]
          examples: [OK]
        version:
          type: string
          examples: ["1.0.0"]
      required: [status, version]

    Info:
      type: object
      description: >
        Compactor information.
        (needs to be studied what information is made available)
      properties:
        compactor_id:
          type: string
          description: Unique compactor identifier
          examples: ["WC-12345"]
        vendor: 
          type: string
          description: Compactor manufacturer
          examples: ["EcoPress"] 
        model: 
          type: string
          description: Compactor model name
          examples: ["EMC mini"]
        hw_version:
          type: string
          description: Hardware version
          examples: ["1.2"]
        sw_version:
          type: string
          description: Software version
          examples: ["1.1"]
      required: [compactor_id, sw_version]

    Credential:
      type: object
      description: Customer credential scanned/entered at device
      properties:
        type:
          type: string
          enum: [PIN, QR, RFID]
        value:
          type: string
          examples: ["1234567890"]
      required: [type, value]

    EntitlementCheckResponse:
      type: object
      description: >
        Response to entitlements check request. 
        Defines allowed operations for the end customer. 
      properties:
        locale: 
          type: string
          description: >
            IETF BCP47 language tag to use for UI localization (e.g., "fi-FI", "sv-SE", "en-GB").
            Use lowercase language + uppercase region.
          examples: ["fi-FI"]
        items:
          type: array
          items: { $ref: '#/components/schemas/EntitlementDecision' }
        count:
          type: integer
          examples: [1]
      required: [items]

    EntitlementDecision:
      type: object
      description: Description of an entitlement.
      properties:
        action:
          type: string
          description: Entitled action
          enum: [UNLOCK_HATCH]
        allowed:
          type: boolean
          description: true if action is allowed, false otherwise
          examples: [false]
        reason:
          type: string
          description: >
            Human-readable reason text if not allowed.
            This text is already localized in the backend based on customer profile.
          examples: ["Käyttöperehdytys suorittamatta"]
        valid_until:
          $ref: '#/components/schemas/Timestamp'
          description: When the entitlement expires; RFC 3339 timestamp
      required: [action, allowed]
      if:
        properties: 
          allowed: 
            const: false
      then:
        required: [reason]
        not:
          required: [valid_until]
      else:
        required: [valid_until]
        not:
          required: [reason]

    Status:
      type: object
      description: Compactor status message
      properties:
        timestamp:
          $ref: '#/components/schemas/Timestamp'
          description: Timestamp when status was measured.
        compactor_id:
          type: string
          description: Unique compactor identifier
          examples: ["WC-12345"]
        measurements:
          type: array
          description: List of measurements (telemetry)
          items:
            $ref: '#/components/schemas/Measurement'
        measurements_count:
          type: integer
          description: Count of measurements
          examples: [1]
        active_alarms:
          type: array       
          description: List of active alarms 
          items:
            $ref: '#/components/schemas/ActiveAlarm'
        active_alarms_count:
          type: integer
          description: Count of active alarms
          examples: [1]
      required: [timestamp, compactor_id, measurements, active_alarms]

    Measurement:
      type: object
      description: A single measurement
      properties:
        name:
          type: string
          description: Measurement name
          examples: ["temperature"]
        value:
          type: number
          description: Measurement value
          examples: [-8.2]
        unit:
          type: string
          description: Measurement SI unit
          examples: ["°C"]
        extras:
          type: object
          description: Additional information
          additionalProperties: true
      required: [name, value]

    AlarmCode:
      type: object
      properties:
        code:
          type: string
          description: >
            Machine-specific or standardized alarm code.
            Can be used as a key to localize description text.
            See enumeration table for examples. 
            NOTICE: This is an example list of enumerated alarms.
            Final enumeration table to be constructed in the implementation phase.
          examples: ["A-0001"]
        description:
          type: string
          description: >
            Plain english text describing alarm in case 
            localization is not available. 
          examples: ["Hydraulic pump failed"]
        severity:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW]
      required: [code, description]
      enum:
        - code: A-0001
          description: Hydraulic pump failed
          severity: CRITICAL
        - code: A-0002
          description: Hatch open for too long
          severity: MEDIUM
        - code: A-0003
          description: Connection to backend disconnected
          severity: MEDIUM

    ActiveAlarm:
      type: object
      description: An alarm that is currently active in the compactor
      properties:
        timestamp:
          $ref: '#/components/schemas/Timestamp'
          description: Time when alarm became active.
        alarm_code:
          $ref: '#/components/schemas/AlarmCode'
      required: [timestamp, alarm_code, severity]

    EventCode:
      type: object
      properties:
        code:
          type: string
          description: >
            Machine-specific or standardized event code.
            Can be used as a key to localize description text.
            See enumeration table for examples. 
            NOTICE: This is an example list of enumerated events.
            Final enumeration table to be constructed in the implementation phase.
          examples: ["E-0001"]
        description:
          type: string
          description: >
            Plain english text describing event in case 
            localization is not available. 
          examples: ["Compression started"]
      required: [code, description]
      enum:
        - code: E-0001
          description: Compression started
        - code: E-0002
          description: Compression finished
        - code: E-0003
          description: Hatch unlocked
        - code: E-0004
          description: Hatch locked
        - code: E-0005
          description: Hatch opened
        - code: E-0006
          description: Hatch closed

    Event:
      type: object
      description: An event indicating state change in compactor
      properties:
        timestamp:
          $ref: '#/components/schemas/Timestamp'
          description: Time when event occurred.
        compactor_id:
          type: string
          description: Unique compactor identifier
          examples: ["WC-12345"]
        event_id:
          type: string
          description: Unique event identifier
          examples: ["dc65a2b4-8f0b-486f-94ff-861382a3b23a"]
        event_code:
          $ref: '#/components/schemas/EventCode'
        details:
          type: object
          description: Additional information
          additionalProperties: true
      required: [timestamp, compactor_id, event_id, event_code]

    Alarm:
      type: object
      description: An alarm event indicating start or end of abnormal situation in compactor
      properties:
        timestamp:
          $ref: '#/components/schemas/Timestamp'
          description: Time when alarm event occured.
        compactor_id:
          type: string
          description: Unique compactor identifier
          examples: ["WC-12345"]
        alarm_event_id:
          type: string
          description: Stable id to correlate activation/clear.
          examples: ["cb825031-7ee6-411a-941b-f9a13aadb181"]
        alarm_state:
          type: string
          enum: [ACTIVATED, CLEARED]
        alarm_code:
          $ref: '#/components/schemas/AlarmCode'
        details:
          type: object
          description: Additional information
          additionalProperties: true
      required: [timestamp, compactor_id, alarm_event_id, alarm_type, alarm_code]

    Command:
      type: object
      properties:
        command_id:
          type: string
          description: Unique command identifier
          examples: ["dc65a2b4-8f0b-486f-94ff-861382a3b23a"]
        action: 
          type: string
          enum: 
            - REBOOT
            - SW_UPDATE
            - REPORT_INFO
            - REPORT_STATUS
            - UNLOCK_HATCH
          description: >
            Command to execute.
            NOTICE: This is an example list of commands. 
            Final list of supported commands is made in the implementation phase.
        issued_at: 
          $ref: '#/components/schemas/Timestamp'
          description: Time when command was issued.
        expire_at: 
          $ref: '#/components/schemas/Timestamp'
          description: Time after the command is re-issued if no command report was received.
        attempt:
          type: integer
          minimum: 1
          description: Attempt counter that is increased by 1 in every command re-issue.
        priority:
          type: string
          enum: [low, normal, high]
          default: normal
          description: Command priority
      required: [command_id, type, issued_at, attempt]

    CommandReport:
      type: object
      properties:
        command_id:
          type: string
          description: Unique command identifier
          examples: ["dc65a2b4-8f0b-486f-94ff-861382a3b23a"]
        finished_at: 
          $ref: '#/components/schemas/Timestamp'
          description: Time when command was finished.
        status: 
          type: string
          enum: [SUCCEEDED, FAILED]
          description: Commmand execution status
        error:
          type: object
          description: Error details if execution failed
          required: [code]
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true
      required: [command_id, finished_at, status]
      if:
        properties: 
          status: 
            const: FAILED
      then:
        required: [error]
      else:
        not:
          required: [error]

    Problem:
      type: object
      description: RFC 7807 Problem Details
      properties:
        type:
          type: string
          format: uri
          examples: ["https://api.example.com/problems/bad-request"]
        title:
          type: string
          examples: ["Bad Request"]
        status:
          type: integer
          examples: [400]
        detail:
          type: string
          examples: ["The 'value' field is required."]
        instance:
          type: string
          format: uri
          examples: ["https://api.example.com/requests/123e4567-e89b-12d3-a456-426614174000"]
      required: [title, status]